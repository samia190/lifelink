# ===========================================
# LIFELINK - Render Blueprint (Infrastructure as Code)
# ===========================================
# Deploy: Connect repo → Render detects this file → creates all services
# Docs: https://docs.render.com/blueprint-spec

services:
  # ─── Backend API (Express + Prisma) ───
  - type: web
    name: lifelink-api
    runtime: node
    region: frankfurt  # closest to East Africa
    plan: starter
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: npm run start:prod
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "4000"
      - key: TRUST_PROXY
        value: "true"
      - key: DATABASE_URL
        sync: false  # Set to your MongoDB Atlas connection string
      - key: REDIS_URL
        fromService:
          type: redis
          name: lifelink-redis
          property: connectionString
      - key: APP_URL
        sync: false  # Set to your frontend Render URL
      - key: API_URL
        sync: false  # Set to this service's URL
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: ENCRYPTION_IV
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: MPESA_CONSUMER_KEY
        sync: false
      - key: MPESA_CONSUMER_SECRET
        sync: false
      - key: MPESA_PASSKEY
        sync: false
      - key: MPESA_CALLBACK_URL
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: CORS_ORIGINS
        sync: false  # Comma-separated frontend URLs

  # ─── Frontend (Next.js SSR via Docker) ───
  - type: web
    name: lifelink-web
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: frontend
    dockerfilePath: ./Dockerfile
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        sync: false  # Set to: https://lifelink-api.onrender.com/api
      - key: NEXT_TELEMETRY_DISABLED
        value: "1"

  # ─── Redis ───
  - type: redis
    name: lifelink-redis
    region: frankfurt
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # allow only Render internal

# ─── Database ───
# MongoDB Atlas is used instead of Render PostgreSQL.
# Set DATABASE_URL env var on the lifelink-api service to your Atlas connection string.
# Atlas free tier (M0) works great for getting started.
